<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Réservation - À l'orée de la forêt</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link href="https://fonts.googleapis.com/css2?family=Pacifico&family=Roboto&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Roboto', sans-serif;
      background: #e6f2ea url('https://www.transparenttextures.com/patterns/leaf.png') repeat;
      display: flex;
      justify-content: center;
      padding: 1rem;
    }
    .form-container {
      background: #fffaf0;
      padding: 1.5rem 2rem;
      border-radius: 20px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.1);
      max-width: 500px;
      width: 100%;
    }
    h1 {
      font-family: 'Roboto', sans-serif;
      color: #4a3c31;
      text-align: center;
      margin-bottom: 1.5rem;
      font-size: 2rem;
    }
    label {
      display: block;
      margin-top: 1rem;
      color: #5c4431;
      font-size: 1rem;
    }
    input, select, textarea, button {
      width: 100%;
      padding: 0.6rem;
      margin-top: 0.3rem;
      border-radius: 12px;
      border: 1px solid #c8b29a;
      font-size: 1rem;
      font-family: inherit;
      box-sizing: border-box;
    }
    textarea { resize: vertical; min-height: 80px; }
    button {
      background: linear-gradient(135deg,#8bbf91,#6ca774);
      color: white;
      border: none;
      margin-top: 1.5rem;
      cursor: pointer;
      font-weight: bold;
      font-size: 1.1rem;
      transition: all 0.3s ease;
    }
    button:hover {
      background: linear-gradient(135deg,#6ca774,#558e61);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    #message {
      margin-top: 1rem;
      font-weight: bold;
      text-align: center;
    }
    .success { color: #2e7d32; }
    .error { color: #b71c1c; }

    /* Responsive small screens */
    @media (max-width: 400px) {
      h1 { font-size: 1.5rem; }
      input, select, textarea, button { font-size: 0.95rem; }
      .form-container { padding: 1rem 1.2rem; }
    }
  </style>
</head>
<body>
  <div class="form-container">
    <h1>À l'Orée de la Forêt<br/>
        Demande de réservation</h1>

    <form id="reservationForm">
      <label>Nom du propriétaire<input type="text" name="nom_proprietaire" required></label>
      <label>Email<input type="email" name="email" required></label>
      <label>Personne autorisée<input type="text" name="personne_autorisee"></label>
      <label>Nombre d’animaux<input type="number" name="nb_animal" min="1" required></label>
      <label>Nom des animaux<input type="text" name="nom_animaux"></label>
      <label>Date d’arrivée<input type="date" id="dateArrivee" name="date_arrivee" required></label>
      <label>Heure d’arrivée<select id="heureArrivee" name="heure_arrivee" required></select></label>
      <label>Date de départ<input type="date" id="dateDepart" name="date_depart" required></label>
      <label>Heure de départ<select id="heureDepart" name="heure_depart" required></select></label>
      <label>Remarque<textarea name="remarque"></textarea></label>
      <button type="submit">Envoyer la réservation</button>
    </form>
    <div id="message"></div>
  </div>

  <script>
  const SUPABASE_URL='https://usatdvopaaxrxjiqhgju.supabase.co';
  const SUPABASE_ANON_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVzYXRkdm9wYWF4cnhqaXFoZ2p1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk1MjUzNDUsImV4cCI6MjA3NTEwMTM0NX0.D52GPw5yZUJWN1oZD_sop7F7nU9WZLM5OMof1TI3IMc';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const form = document.getElementById("reservationForm");
    const message = document.getElementById("message");
    const dateArriveeInput = document.getElementById("dateArrivee");
    const dateDepartInput = document.getElementById("dateDepart");
    const heureArriveeSelect = document.getElementById("heureArrivee");
    const heureDepartSelect = document.getElementById("heureDepart");

    function getToday() {
      const today = new Date();
      const yyyy = today.getFullYear();
      const mm = String(today.getMonth()+1).padStart(2,'0');
      const dd = String(today.getDate()).padStart(2,'0');
      return `${yyyy}-${mm}-${dd}`;
    }

    function getOpeningHours(day){
      switch(day){
        case 0: return [{start:"17:00",end:"19:00"}];
        case 6: return [{start:"10:00",end:"12:00"}];
        default: return [{start:"09:00",end:"14:00"},{start:"17:00",end:"19:00"}];
      }
    }

    function generateTimeOptions(day){
      const ranges = getOpeningHours(day);
      const options = [];
      ranges.forEach(r=>{
        let [h,m] = r.start.split(":").map(Number);
        const [endH,endM] = r.end.split(":").map(Number);
        while(h<endH||(h===endH && m<endM)){
          const hh=String(h).padStart(2,"0");
          const mm=String(m).padStart(2,"0");
          options.push(`${hh}:${mm}`);
          m+=15;
          if(m>=60){ m=0; h++; }
        }
      });
      return options;
    }

    function updateHourOptions(dateInput, selectInput){
      const date = new Date(dateInput.value);
      if(isNaN(date)) return;
      const day = date.getDay();
      const times = generateTimeOptions(day);
      selectInput.innerHTML="";
      times.forEach(t=>{
        const opt=document.createElement("option");
        opt.value=t;
        opt.textContent=t;
        selectInput.appendChild(opt);
      });
    }

    const todayStr = getToday();
    dateArriveeInput.value = todayStr;
    dateArriveeInput.min = todayStr;
    dateDepartInput.value = todayStr;
    dateDepartInput.min = todayStr;

    updateHourOptions(dateArriveeInput, heureArriveeSelect);
    updateHourOptions(dateDepartInput, heureDepartSelect);

    function validateDatesAndHours(){
      const arrivalDate = new Date(dateArriveeInput.value+"T"+heureArriveeSelect.value);
      const departureDate = new Date(dateDepartInput.value+"T"+heureDepartSelect.value);
      if(departureDate <= arrivalDate){
        message.textContent="❌ La date/heure de départ doit être postérieure à l'arrivée.";
        message.className="error";
        return false;
      }
      message.textContent="";
      return true;
    }

    dateArriveeInput.addEventListener("change", ()=>{
      updateHourOptions(dateArriveeInput, heureArriveeSelect);
      dateDepartInput.min=dateArriveeInput.value;
      validateDatesAndHours();
    });
    heureArriveeSelect.addEventListener("change",validateDatesAndHours);
    dateDepartInput.addEventListener("change",()=>{
      updateHourOptions(dateDepartInput, heureDepartSelect);
      validateDatesAndHours();
    });
    heureDepartSelect.addEventListener("change",validateDatesAndHours);

    form.addEventListener("submit", async e=>{
      e.preventDefault();
      if(!validateDatesAndHours()) return;

      message.textContent="Envoi en cours...";
      const formData = new FormData(form);
      const reservation = Object.fromEntries(formData.entries());

      try{
        const {data,error} = await supabaseClient
          .from("reservations")
          .insert([reservation])
          .select();
        if(error){
          message.textContent="❌ Erreur : "+error.message;
          message.className="error";
        } else{
          message.textContent="✅ Réservation enregistrée avec succès !";
          message.className="success";
          form.reset();
          dateArriveeInput.value = todayStr;
          dateDepartInput.value = todayStr;
          updateHourOptions(dateArriveeInput, heureArriveeSelect);
          updateHourOptions(dateDepartInput, heureDepartSelect);
        }
      }catch(err){
        message.textContent="⚡ Exception : "+err.message;
        message.className="error";
      }
    });
  </script>
</body>
</html>




