<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Réservation - À l'Orée de la Forêt</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.emailjs.com/dist/email.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Pacifico&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet" />
<style>
:root { --vert-clair: #cfead2; --vert-fonce: #5c8a63; --brun-texte: #4a3c31; }
body { font-family: 'Roboto', sans-serif; background: #ffffff; min-height: 100vh; display: flex; justify-content: center; align-items: center; padding: 2rem; }
.form-container { background: var(--vert-clair); border-radius: 24px; box-shadow: 0 8px 25px rgba(0,0,0,0.08); max-width: 520px; width: 100%; padding: 2rem 2.5rem; text-align: center; position: relative;}
.form-container img { max-width: 140px; height: auto; margin-bottom: 1rem; }
h1 { color: var(--brun-texte); font-size: 2rem; margin-bottom: 1rem; line-height: 1.3; }
.subtitle-script { display: block; font-size: 1.1rem; color: var(--brun-texte); margin-top: 0.3rem; }
#encartFermeture { border: 2px solid #b6dab8; border-radius: 12px; padding: 1rem; text-align: left; margin-bottom: 1.5rem; font-size: 0.95rem; color: var(--brun-texte); background: #fff; }
label { display: block; text-align: left; color: var(--brun-texte); font-weight: 500; margin-top: 1rem; margin-bottom: 0.3rem; }
input, select, textarea { width: 100%; padding: 0.7rem 0.9rem; border-radius: 12px; border: 1px solid #c9b6a4; background-color: #fff; font-size: 1rem; box-sizing: border-box; }
button { background: linear-gradient(135deg, var(--vert-clair), var(--vert-fonce)); color: white; border: none; padding: 0.8rem 1rem; border-radius: 14px; font-size: 1.1rem; font-weight: bold; margin-top: 1.8rem; width: 100%; cursor: pointer; transition: transform 0.1s ease, box-shadow 0.1s ease; }
button:hover { transform: scale(1.02); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
.datetime-group { display: flex; flex-direction: column; margin-top: 1rem; }
.datetime-fields { display: flex; gap: 0.5rem; flex-wrap: wrap; }
.datetime-fields input, .datetime-fields select { flex: 1; }
.datetime-fields input { border-radius: 12px 0 0 12px; border-right: none; }
.datetime-fields select { border-radius: 0 12px 12px 0; }
#popupMessage { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:9999; justify-content:center; align-items:center; }
#popupMessage div { background:#fff; padding:2rem; border-radius:16px; max-width:400px; width:90%; text-align:center; position:relative; }
#popupMessage p { font-size:1.1rem; color:#333; margin-bottom:1.5rem; white-space: pre-line; }
#popupMessage button { background:var(--vert-fonce); color:#fff; padding:0.7rem 1.2rem; border:none; border-radius:12px; font-size:1rem; cursor:pointer; }
</style>
</head>
<body>

<div class="form-container">
  <img src="logo.png" alt="Logo À l'Orée de la Forêt" />
  <h1>
    À l’Orée de la Forêt<br>
    <span class="subtitle-script">Pension canine familiale - Cheillé</span>
    <span class="subtitle-script">Demande de réservation</span>
  </h1>

  <div id="encartFermeture"></div>

  <form id="reservationForm">
    <label>Nom et prénom du propriétaire</label>
    <input type="text" name="nom_proprietaire" required />
    <label>Email</label>
    <input type="email" name="email" required />
    <label>Nombre de chiens</label>
    <input type="number" name="nb_chien" min="1" value="1" required />
    <div id="nomsChiensContainer"></div>

    <div class="datetime-group">
      <label>Arrivée</label>
      <div class="datetime-fields">
        <input type="date" id="dateArrivee" name="date_arrivee" />
        <select id="heureArrivee" name="heure_arrivee"></select>
      </div>
    </div>

    <div class="datetime-group">
      <label>Départ</label>
      <div class="datetime-fields">
        <input type="date" id="dateDepart" name="date_depart" />
        <select id="heureDepart" name="heure_depart"></select>
      </div>
    </div>

    <label>Remarque</label>
    <textarea name="remarque"></textarea>

    <button type="submit">Envoyer la réservation</button>
  </form>
</div>

<div id="popupMessage">
  <div>
    <p id="popupText"></p>
    <button id="popupClose">OK</button>
  </div>
</div>

<script>
/* --- INIT EMAILJS --- */
(function(){ emailjs.init("YOUR_EMAILJS_PUBLIC_KEY"); })(); // <-- remplacer par ta clé EmailJS

/* --- SUPABASE --- */
const SUPABASE_URL = 'https://usatdvopaaxrxjiqhgju.supabase.co';
const SUPABASE_ANON_KEY = 'YOUR_SUPABASE_ANON_KEY';
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* --- ELEMENTS --- */
const form = document.getElementById("reservationForm");
const dateArriveeInput = document.getElementById("dateArrivee");
const dateDepartInput = document.getElementById("dateDepart");
const heureArriveeSelect = document.getElementById("heureArrivee");
const heureDepartSelect = document.getElementById("heureDepart");
const nbChienInput = form.querySelector('input[name="nb_chien"]');
const nomsChiensContainer = document.getElementById("nomsChiensContainer");
const encartFermeture = document.getElementById("encartFermeture");

/* --- POPUP --- */
const popup = document.getElementById("popupMessage");
const popupText = document.getElementById("popupText");
const popupClose = document.getElementById("popupClose");
function showPopup(msg){ popupText.textContent = msg; popup.style.display="flex"; }
popupClose.addEventListener("click", ()=>{ popup.style.display="none"; });

/* --- Fermetures --- */
const periodesFermees = [
  { debut: "2025-12-20", fin: "2025-12-26" },
  { debut: "2026-02-22", fin: "2026-02-28" },
  { debut: "2026-04-18", fin: "2026-04-26" },
  { debut: "2026-05-27", fin: "2026-05-31" },
  { debut: "2026-07-03", fin: "2026-07-23" },
  { debut: "2026-10-16", fin: "2026-10-24" },
  { debut: "2026-12-19", fin: "2026-12-27" }
];
function afficherEncartFermeture() {
  let contenu = "<strong>Périodes de fermeture :</strong><br>";
  periodesFermees.forEach(p=>{
    const debut = new Date(p.debut);
    const fin = new Date(p.fin);
    contenu+=`• du <strong>${debut.toLocaleDateString('fr-FR')}</strong> au <strong>${fin.toLocaleDateString('fr-FR')}</strong><br>`;
  });
  encartFermeture.innerHTML = contenu;
}
afficherEncartFermeture();

/* --- Noms chiens dynamiques --- */
function updateNomsChiens(){
  let nb=parseInt(nbChienInput.value)||1; if(nb<1) nb=1; nbChienInput.value=nb;
  nomsChiensContainer.innerHTML="";
  for(let i=1;i<=nb;i++){
    const label=document.createElement("label"); label.textContent=nb===1?"Nom du chien":`Nom du chien ${i}`;
    const input=document.createElement("input"); input.type="text"; input.name=`nom_chien_input_${i}`; input.required=true;
    nomsChiensContainer.appendChild(label); nomsChiensContainer.appendChild(input);
  }
}
nbChienInput.addEventListener("input", updateNomsChiens);
updateNomsChiens();

/* --- Horaires simplifiées --- */
function generateTimeOptions(){ return ["09:00","10:00","11:00","12:00","13:00","14:00","15:00","16:00","17:00"]; }
function updateHourOptions(selectInput){ selectInput.innerHTML=""; generateTimeOptions().forEach(t=>{ const opt=document.createElement("option"); opt.value=t; opt.textContent=t; selectInput.appendChild(opt);}); }
updateHourOptions(heureArriveeSelect); updateHourOptions(heureDepartSelect);

/* --- Initialiser dates à aujourd'hui --- */
const todayStr = new Date().toISOString().split("T")[0];
dateArriveeInput.value = todayStr;
dateDepartInput.value = todayStr;
dateArriveeInput.min = todayStr;
dateDepartInput.min = todayStr;

/* --- Copier date arrivée dans date départ --- */
dateArriveeInput.addEventListener("change", ()=>{
    if(dateArriveeInput.value){
        dateDepartInput.value = dateArriveeInput.value;
        dateDepartInput.min = dateArriveeInput.value;
    }
});

/* --- Format date jj mois aaaa à hh:mm --- */
function formatDateFR(dateStr, timeStr){
  if(!dateStr || !timeStr) return "";
  const date = new Date(dateStr + "T" + timeStr);
  return date.toLocaleDateString("fr-FR", {day:"2-digit", month:"long", year:"numeric"}) + " à " + date.toLocaleTimeString("fr-FR",{hour:"2-digit",minute:"2-digit"});
}

/* --- SUBMIT --- */
form.addEventListener("submit", async e=>{
  e.preventDefault();
  if(!heureArriveeSelect.value || !heureDepartSelect.value){ showPopup("⚠️ Choisissez les créneaux horaires."); return; }

  const formData = new FormData(form);
  const reservation = {
    nom_proprietaire: formData.get("nom_proprietaire"),
    email: formData.get("email"),
    nb_chien: parseInt(formData.get("nb_chien"))||1,
    nom_chien: [],
    date_arrivee: formData.get("date_arrivee"),
    heure_arrivee: formData.get("heure_arrivee"),
    date_depart: formData.get("date_depart"),
    heure_depart: formData.get("heure_depart"),
    remarque: formData.get("remarque")
  };
  for(let i=1;i<=reservation.nb_chien;i++){ const n=formData.get(`nom_chien_input_${i}`); if(n) reservation.nom_chien.push(n); }
  reservation.nom_chien=reservation.nom_chien.join(",");

  try{
    const {error} = await supabaseClient.from("reservations").insert([reservation]);
    if(error) { showPopup("❌ Erreur : "+error.message); return; }

    const message = `✅ Votre réservation a bien été enregistrée du ${formatDateFR(reservation.date_arrivee,reservation.heure_arrivee)} ` +
                    `au ${formatDateFR(reservation.date_depart,reservation.heure_depart)}.\nNous vous tiendrons informé de la disponibilité.`;

    showPopup(message);

    form.reset(); 
    dateArriveeInput.value = todayStr;
    dateDepartInput.value = todayStr;
    updateNomsChiens(); updateHourOptions(heureArriveeSelect); updateHourOptions(heureDepartSelect);

    const emailParams = {
      from_name: "Isabelle - Pension À l'Orée de la Forêt",
      from_email: "a.l.oree.de.la.foret.37@gmail.com",
      to_email: reservation.email,
      to_name: reservation.nom_proprietaire,
      message: message
    };
    emailjs.send("YOUR_SERVICE_ID","YOUR_TEMPLATE_ID", emailParams)
      .then(()=>console.log("Email envoyé avec succès !"))
      .catch(err=>console.error("Erreur envoi email :", err));

  } catch(err){ showPopup("⚡ Exception : "+(err.message||err)); }
});
</script>
</body>
</html>
