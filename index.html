<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>R√©servation - √Ä l'Or√©e de la For√™t</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link href="https://fonts.googleapis.com/css2?family=Pacifico&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet" />
  <style>
    :root {
      --vert-clair: #cfead2;   /* vert plus clair */
      --vert-fonce: #5c8a63;
      --brun-texte: #4a3c31;
    }

    body {
      font-family: 'Roboto', sans-serif;
      background: #ffffff;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 2rem;
    }

    .form-container {
      background: var(--vert-clair);
      border-radius: 24px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.08);
      max-width: 520px;
      width: 100%;
      padding: 2rem 2.5rem;
      text-align: center;
    }

    .form-container img {
      max-width: 140px;
      height: auto;
      margin-bottom: 1rem;
    }

    h1 {
      color: var(--brun-texte);
      font-size: 2rem;
      margin-bottom: 1rem;
      line-height: 1.3;
    }

    .subtitle-script {
      display: block;
      font-size: 1.1rem;
      color: var(--brun-texte);
      margin-top: 0.3rem;
    }

    #encartFermeture {
      border: 2px solid #b6dab8;
      border-radius: 12px;
      padding: 1rem;
      text-align: left;
      margin-bottom: 1.5rem;
      font-size: 0.95rem;
      color: var(--brun-texte);
      background: #fff;
    }

    label {
      display: block;
      text-align: left;
      color: var(--brun-texte);
      font-weight: 500;
      margin-top: 1rem;
      margin-bottom: 0.3rem;
    }

    input, select, textarea {
      width: 100%;
      padding: 0.7rem 0.9rem;
      border-radius: 12px;
      border: 1px solid #c9b6a4;
      background-color: #fff;
      font-size: 1rem;
      box-sizing: border-box;
    }

    button {
      background: linear-gradient(135deg, var(--vert-clair), var(--vert-fonce));
      color: white;
      border: none;
      padding: 0.8rem 1rem;
      border-radius: 14px;
      font-size: 1.1rem;
      font-weight: bold;
      margin-top: 1.8rem;
      width: 100%;
      cursor: pointer;
      transition: transform 0.1s ease, box-shadow 0.1s ease;
    }

    button:hover {
      transform: scale(1.02);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    #message { margin-top: 1rem; font-weight: 500; }
    .success { color: #2e7d32; }
    .error { color: #b71c1c; }

    @media (max-width: 500px) {
      .form-container { padding: 1.5rem 1.3rem; }
      h1 { font-size: 1.6rem; }
    }
  </style>
</head>

<body>
  <div class="form-container">
    <img src="logo.png" alt="Logo √Ä l'Or√©e de la For√™t" />
    <h1>
      √Ä l‚ÄôOr√©e de la For√™t<br>
      <span class="subtitle-script">Pension canine familiale - Cheill√©</span>
      <span class="subtitle-script">Demande de r√©servation</span>
    </h1>

    <div id="encartFermeture"></div>

    <form id="reservationForm">
      <label>Nom et pr√©nom du propri√©taire</label>
      <input type="text" name="nom_proprietaire" required />

      <label>Email</label>
      <input type="email" name="email" required />

      <label>Nombre de chiens</label>
      <input type="number" name="nb_chien" min="1" value="1" required />
      <div id="nomsChiensContainer"></div>

      <label>Date d‚Äôarriv√©e</label>
      <input type="date" id="dateArrivee" name="date_arrivee" required />

      <label>Heure d‚Äôarriv√©e</label>
      <select id="heureArrivee" name="heure_arrivee" required></select>

      <label>Date de d√©part</label>
      <input type="date" id="dateDepart" name="date_depart" required />

      <label>Heure de d√©part</label>
      <select id="heureDepart" name="heure_depart" required></select>

      <label>Remarque</label>
      <textarea name="remarque"></textarea>

      <button type="submit">Envoyer la r√©servation</button>
    </form>

    <div id="message"></div>
  </div>

  <script>
    const SUPABASE_URL='https://usatdvopaaxrxjiqhgju.supabase.co';
    const SUPABASE_ANON_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVzYXRkdm9wYWF4cnhqaXFoZ2p1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk1MjUzNDUsImV4cCI6MjA3NTEwMTM0NX0.D52GPw5yZUJWN1oZD_sop7F7nU9WZLM5OMof1TI3IMc';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const form = document.getElementById("reservationForm");
    const message = document.getElementById("message");
    const dateArriveeInput = document.getElementById("dateArrivee");
    const dateDepartInput = document.getElementById("dateDepart");
    const heureArriveeSelect = document.getElementById("heureArrivee");
    const heureDepartSelect = document.getElementById("heureDepart");
    const nbChienInput = form.querySelector('input[name="nb_chien"]');
    const nomsChiensContainer = document.getElementById("nomsChiensContainer");
    const encartFermeture = document.getElementById("encartFermeture");

    // --- P√©riodes de fermeture (exemples) ---
    const periodesFermees = [
      { debut: "2025-11-19", fin: "2025-11-26" },
      { debut: "2025-12-20", fin: "2025-12-26" },
      { debut: "2026-02-22", fin: "2026-02-28" }
    ];

    function afficherEncartFermeture() {
      const aujourdHui = new Date();
      let contenu = "üå≤ <strong>P√©riodes de fermeture :</strong><br>";
      let proche = false;
      periodesFermees.forEach(p => {
        const debut = new Date(p.debut);
        const fin = new Date(p.fin);
        const debutTxt = debut.toLocaleDateString("fr-FR", { day: '2-digit', month: 'long', year: 'numeric' });
        const finTxt = fin.toLocaleDateString("fr-FR", { day: '2-digit', month: 'long', year: 'numeric' });
        contenu += `‚Ä¢ du <strong>${debutTxt}</strong> au <strong>${finTxt}</strong><br>`;
        const diffJours = Math.floor((debut - aujourdHui) / (1000 * 60 * 60 * 24));
        if (diffJours >= 0 && diffJours <= 15) proche = true;
      });
      encartFermeture.innerHTML = contenu;
      encartFermeture.style.background = proche ? "#FFF5E5" : "#fff";
      encartFermeture.style.borderColor = proche ? "#E6B800" : "#b6dab8";
    }
    afficherEncartFermeture();

    // --- Jours f√©ri√©s (France m√©tropole) ---
    function getEasterDate(year) {
      const f = Math.floor,
        G = year % 19,
        C = f(year / 100),
        H = (C - f(C / 4) - f((8 * C + 13) / 25) + 19 * G + 15) % 30,
        I = H - f(H / 28) * (1 - f(29 / (H + 1)) * f((21 - G) / 11)),
        J = (year + f(year / 4) + I + 2 - C + f(C / 4)) % 7,
        L = I - J,
        month = 3 + f((L + 40) / 44),
        day = L + 28 - 31 * f(month / 4);
      return new Date(year, month - 1, day);
    }

    function addDays(date, days) {
      const d = new Date(date);
      d.setDate(d.getDate() + days);
      return d;
    }

    function formatDate(date) {
      return date.toISOString().split("T")[0];
    }

    function isHoliday(dateStr) {
      if (!dateStr) return false;
      const date = new Date(dateStr);
      if (isNaN(date)) return false;
      const year = date.getFullYear();
      const easter = getEasterDate(year);
      const holidays = [
        `${year}-01-01`, // Jour de l'an
        formatDate(addDays(easter, 1)), // Lundi de P√¢ques
        `${year}-05-01`, // F√™te du Travail
        `${year}-05-08`, // Victoire 1945
        formatDate(addDays(easter, 39)), // Ascension
        formatDate(addDays(easter, 50)), // Lundi de Pentec√¥te
        `${year}-07-14`, // F√™te nationale
        `${year}-08-15`, // Assomption
        `${year}-11-01`, // Toussaint
        `${year}-11-11`, // Armistice
        `${year}-12-25`  // No√´l
      ];
      return holidays.includes(dateStr);
    }

    // --- Horaires selon jour ET type (arrivee/depart) ---
    function getOpeningHours(day, dateStr, type) {
      const holiday = isHoliday(dateStr);
      // Dimanche ou jour f√©ri√©
      if (holiday || day === 0) {
        if (type === "arrivee") return [{ start: "17:00", end: "18:00" }];
        if (type === "depart") return [{ start: "11:00", end: "12:00" }, { start: "17:00", end: "18:00" }];
      }

      // Jours normaux
      switch (day) {
        case 1:
        case 2:
          return [{ start: "09:00", end: "14:00" }, { start: "16:00", end: "17:00" }];
        case 3:
        case 4:
        case 5:
          return [{ start: "09:00", end: "14:00" }, { start: "17:00", end: "19:00" }];
        case 6:
          return [{ start: "10:00", end: "12:00" }, { start: "17:00", end: "18:00" }];
        default:
          return [];
      }
    }

    function generateTimeOptions(day, dateStr, type) {
      const ranges = getOpeningHours(day, dateStr, type);
      const options = [];
      ranges.forEach(r => {
        let [h, m] = r.start.split(":").map(Number);
        const [endH, endM] = r.end.split(":").map(Number);
        // add times every 15 minutes, excluding the end moment
        while (h < endH || (h === endH && m < endM)) {
          const hh = String(h).padStart(2, "0");
          const mm = String(m).padStart(2, "0");
          options.push(`${hh}:${mm}`);
          m += 15;
          if (m >= 60) { m = 0; h++; }
        }
      });
      return options;
    }

    function updateHourOptions(dateInput, selectInput, type) {
      const dateVal = dateInput.value;
      const date = new Date(dateVal);
      if (isNaN(date)) {
        // vider si date invalide
        selectInput.innerHTML = "";
        return;
      }
      const day = date.getDay();
      const times = generateTimeOptions(day, dateVal, type);
      selectInput.innerHTML = "";
      if (times.length === 0) {
        const opt = document.createElement("option");
        opt.value = "";
        opt.textContent = "Aucun cr√©neau disponible";
        selectInput.appendChild(opt);
        return;
      }
      times.forEach(t => {
        const opt = document.createElement("option");
        opt.value = t;
        opt.textContent = t;
        selectInput.appendChild(opt);
      });
    }

    // --- Initialisation des dates √† aujourd'hui et des selects ---
    function getTodayISO() {
      const today = new Date();
      const yyyy = today.getFullYear();
      const mm = String(today.getMonth() + 1).padStart(2, '0');
      const dd = String(today.getDate()).padStart(2, '0');
      return `${yyyy}-${mm}-${dd}`;
    }

    const todayStr = getTodayISO();
    // positionner la date d'arriv√©e et la date de d√©part et le min
    dateArriveeInput.value = todayStr;
    dateArriveeInput.min = todayStr;
    dateDepartInput.value = todayStr;
    dateDepartInput.min = todayStr;

    // remplir imm√©diatement les selects d'heure avec le bon type
    updateHourOptions(dateArriveeInput, heureArriveeSelect, "arrivee");
    updateHourOptions(dateDepartInput, heureDepartSelect, "depart");

    // si l'utilisateur change la date d'arriv√©e : mettre √† jour min du d√©part et les heures d'arriv√©e
    dateArriveeInput.addEventListener("change", () => {
      // mettre √† jour min du d√©part
      if (dateArriveeInput.value) {
        dateDepartInput.min = dateArriveeInput.value;
        // si dateDepart < dateArrivee alors on ajuste dateDepart
        if (dateDepartInput.value && (new Date(dateDepartInput.value) < new Date(dateArriveeInput.value))) {
          dateDepartInput.value = dateArriveeInput.value;
        }
      } else {
        // si dateArrivee vide, on remet min aujourd'hui
        dateDepartInput.min = todayStr;
      }
      updateHourOptions(dateArriveeInput, heureArriveeSelect, "arrivee");
      // aussi rafra√Æchir heures de d√©part au cas o√π min a chang√©
      updateHourOptions(dateDepartInput, heureDepartSelect, "depart");
    });

    dateDepartInput.addEventListener("change", () => {
      // si dateDepart est inf√©rieure √† min, on corrige
      if (dateDepartInput.value && dateArriveeInput.value && (new Date(dateDepartInput.value) < new Date(dateArriveeInput.value))) {
        dateDepartInput.value = dateArriveeInput.value;
      }
      updateHourOptions(dateDepartInput, heureDepartSelect, "depart");
    });

    // --- G√©n√©ration dynamique des champs noms de chiens ---
    function updateNomsChiens() {
      const nb = parseInt(nbChienInput.value) || 0;
      nomsChiensContainer.innerHTML = "";
      for (let i = 1; i <= nb; i++) {
        const label = document.createElement("label");
        label.textContent = (nb === 1) ? "Nom du chien" : `Nom du chien ${i}`;
        const input = document.createElement("input");
        input.type = "text";
        input.name = `nom_chien_input_${i}`;
        input.required = true;
        nomsChiensContainer.appendChild(label);
        nomsChiensContainer.appendChild(input);
      }
    }
    nbChienInput.addEventListener("input", updateNomsChiens);
    updateNomsChiens();

    // --- Soumission vers Supabase ---
    form.addEventListener("submit", async e => {
      e.preventDefault();
      // v√©rification simple : s'assurer que les selects ont une valeur non vide
      if (!heureArriveeSelect.value) {
        message.textContent = "‚ùå Choisissez un cr√©neau d'arriv√©e valide.";
        message.className = "error";
        return;
      }
      if (!heureDepartSelect.value) {
        message.textContent = "‚ùå Choisissez un cr√©neau de d√©part valide.";
        message.className = "error";
        return;
      }

      message.textContent = "Envoi en cours...";
      message.className = "";

      const formData = new FormData(form);
      const reservation = {
        nom_proprietaire: formData.get("nom_proprietaire"),
        email: formData.get("email"),
        nb_chien: parseInt(formData.get("nb_chien")) || 0,
        nom_chien: [],
        date_arrivee: formData.get("date_arrivee"),
        heure_arrivee: formData.get("heure_arrivee"),
        date_depart: formData.get("date_depart"),
        heure_depart: formData.get("heure_depart"),
        remarque: formData.get("remarque")
      };

      for (let i = 1; i <= reservation.nb_chien; i++) {
        const n = formData.get(`nom_chien_input_${i}`);
        if (n) reservation.nom_chien.push(n);
      }
      reservation.nom_chien = reservation.nom_chien.join(",");

      try {
        const { error } = await supabaseClient.from("reservations").insert([reservation]);
        if (error) {
          message.textContent = "‚ùå Erreur : " + error.message;
          message.className = "error";
        } else {
          message.textContent = "‚úÖ R√©servation enregistr√©e avec succ√®s !";
          message.className = "success";
          form.reset();
          // r√©initialiser dates et selects apr√®s reset
          dateArriveeInput.value = todayStr;
          dateDepartInput.value = todayStr;
          dateArriveeInput.min = todayStr;
          dateDepartInput.min = todayStr;
          updateHourOptions(dateArriveeInput, heureArriveeSelect, "arrivee");
          updateHourOptions(dateDepartInput, heureDepartSelect, "depart");
          nomsChiensContainer.innerHTML = "";
          updateNomsChiens();
        }
      } catch (err) {
        message.textContent = "‚ö° Exception : " + (err.message || err);
        message.className = "error";
      }
    });
  </script>
</body>
</html>
