<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Réservation - À l'Orée de la Forêt</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link href="https://fonts.googleapis.com/css2?family=Pacifico&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet" />
  <style>
    :root {
      --vert-clair: #9ec8a7;
      --vert-fonce: #5c8a63;
      --beige-fond: #fffaf0;
      --brun-texte: #4a3c31;
    }
    body {
      font-family: 'Roboto', sans-serif;
      background: linear-gradient(to bottom right, #e6f2ea, #d2e5d7);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 2rem;
    }
    .form-container {
      background: var(--beige-fond);
      border-radius: 24px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.1);
      max-width: 520px;
      width: 100%;
      padding: 2rem 2.5rem;
      text-align: center;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .form-container:hover { transform: translateY(-4px); box-shadow: 0 12px 30px rgba(0,0,0,0.15); }
    .form-container img { max-width: 140px; height: auto; margin-bottom: 1rem; }
    h1 {
    font-family: 'Style Script';
    color: var(--brun-texte);
    font-size: 2rem;
    margin-bottom: 1rem;
    line-height: 1.3;
    text-align: center;
  }
  
  .subtitle-script {
    display: block;
    font-size: 1.1rem;
    font-family: 'Pacifico', cursive;
    color: var(--vert-fonce);
    font-weight: normal;
    margin-top: 0.3rem;
  }
    p.subtitle { font-size: 1rem; color: #6b5849; margin-bottom: 1.5rem; }
    label { display: block; text-align: left; color: var(--brun-texte); font-weight: 500; margin-top: 1rem; margin-bottom: 0.3rem; }
    input, select, textarea { width: 100%; padding: 0.7rem 0.9rem; border-radius: 12px; border: 1px solid #c9b6a4; background-color: #fff; font-size: 1rem; transition: all 0.25s ease; box-sizing: border-box; }
    input:focus, select:focus, textarea:focus { border-color: var(--vert-fonce); outline: none; box-shadow: 0 0 6px rgba(92,138,99,0.4); }
    textarea { resize: vertical; min-height: 80px; }
    button { background: linear-gradient(135deg, var(--vert-clair), var(--vert-fonce)); color: white; border: none; padding: 0.8rem 1rem; border-radius: 14px; font-size: 1.1rem; font-weight: bold; margin-top: 1.8rem; width: 100%; cursor: pointer; transition: all 0.3s ease; }
    button:hover { background: linear-gradient(135deg, var(--vert-fonce), #4b7552); transform: translateY(-2px); box-shadow: 0 6px 15px rgba(0,0,0,0.2); }
    #message { margin-top: 1rem; font-weight: 500; }
    .success { color: #2e7d32; }
    .error { color: #b71c1c; }
    @media (max-width: 500px) { .form-container { padding: 1.5rem 1.3rem; } h1 { font-size: 1.6rem; } input, select, textarea, button { font-size: 0.95rem; } }
  </style>
</head>
<body>
  <div class="form-container">
    <img src="logo.png" alt="Logo À l'Orée de la Forêt" />
    <h1>
      A l’Orée de la Forêt<br>
      <span class="subtitle-script">Pension canine familiale<br>Cheillé</span>
    </h1>
    <p class="subtitle">Demande de réservation</p>

    <form id="reservationForm">
      <label>Nom et prénom du propriétaire</label>
      <input type="text" name="nom_proprietaire" required />

      <label>Email</label>
      <input type="email" name="email" required />

      <label>Nombre de chiens</label>
      <input type="number" name="nb_chien" min="1" value="1" required />
      
      <div id="nomsChiensContainer"></div>

      <label>Date d’arrivée</label>
      <input type="date" id="dateArrivee" name="date_arrivee" required />

      <label>Heure d’arrivée</label>
      <select id="heureArrivee" name="heure_arrivee" required></select>

      <label>Date de départ</label>
      <input type="date" id="dateDepart" name="date_depart" required />

      <label>Heure de départ</label>
      <select id="heureDepart" name="heure_depart" required></select>

      <label>Remarque</label>
      <textarea name="remarque"></textarea>

      <button type="submit">Envoyer la réservation</button>
    </form>

    <div id="message"></div>
  </div>

  <script>
  const SUPABASE_URL='https://usatdvopaaxrxjiqhgju.supabase.co';
  const SUPABASE_ANON_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVzYXRkdm9wYWF4cnhqaXFoZ2p1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk1MjUzNDUsImV4cCI6MjA3NTEwMTM0NX0.D52GPw5yZUJWN1oZD_sop7F7nU9WZLM5OMof1TI3IMc';
  const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const form = document.getElementById("reservationForm");
  const message = document.getElementById("message");
  const dateArriveeInput = document.getElementById("dateArrivee");
  const dateDepartInput = document.getElementById("dateDepart");
  const heureArriveeSelect = document.getElementById("heureArrivee");
  const heureDepartSelect = document.getElementById("heureDepart");
  const nbChienInput = form.querySelector('input[name="nb_chien"]');
  const nomsChiensContainer = document.getElementById("nomsChiensContainer");

  // --- Génération dynamique des noms de chiens ---
function updateNomsChiens() {
  const nb = parseInt(nbChienInput.value) || 0;
  nomsChiensContainer.innerHTML = "";
  for(let i = 1; i <= nb; i++){
    const label = document.createElement("label");
    label.textContent = (nb === 1) ? "Nom du chien" : `Nom du chien #${i}`;
    const input = document.createElement("input");
    input.type = "text";
    input.name = `nom_chien_input_${i}`;
    input.required = true;
    nomsChiensContainer.appendChild(label);
    nomsChiensContainer.appendChild(input);
  }
}


  nbChienInput.addEventListener("input", updateNomsChiens);

  // Générer les champs dès le chargement
  updateNomsChiens();

  // --- Gestion des heures d'ouverture ---
  function getToday() {
    const today = new Date();
    const yyyy = today.getFullYear();
    const mm = String(today.getMonth()+1).padStart(2,'0');
    const dd = String(today.getDate()).padStart(2,'0');
    return `${yyyy}-${mm}-${dd}`;
  }

  function getOpeningHours(day){
    switch(day){
      case 0: return [{start:"17:00",end:"19:00"}];
      case 6: return [{start:"10:00",end:"12:00"}];
      default: return [{start:"09:00",end:"14:00"},{start:"17:00",end:"19:00"}];
    }
  }

  function generateTimeOptions(day){
    const ranges = getOpeningHours(day);
    const options = [];
    ranges.forEach(r=>{
      let [h,m] = r.start.split(":").map(Number);
      const [endH,endM] = r.end.split(":").map(Number);
      while(h<endH||(h===endH && m<endM)){
        const hh=String(h).padStart(2,"0");
        const mm=String(m).padStart(2,"0");
        options.push(`${hh}:${mm}`);
        m+=15;
        if(m>=60){ m=0; h++; }
      }
    });
    return options;
  }

  function updateHourOptions(dateInput, selectInput){
    const date = new Date(dateInput.value);
    if(isNaN(date)) return;
    const day = date.getDay();
    const times = generateTimeOptions(day);
    selectInput.innerHTML="";
    times.forEach(t=>{
      const opt=document.createElement("option");
      opt.value=t;
      opt.textContent=t;
      selectInput.appendChild(opt);
    });
  }

  const todayStr = getToday();
  dateArriveeInput.value = todayStr;
  dateArriveeInput.min = todayStr;
  dateDepartInput.value = todayStr;
  dateDepartInput.min = todayStr;
  updateHourOptions(dateArriveeInput, heureArriveeSelect);
  updateHourOptions(dateDepartInput, heureDepartSelect);

  function validateDatesAndHours(){
    const arrivalDate = new Date(dateArriveeInput.value+"T"+heureArriveeSelect.value);
    const departureDate = new Date(dateDepartInput.value+"T"+heureDepartSelect.value);
    if(departureDate <= arrivalDate){
      message.textContent="❌ La date/heure de départ doit être postérieure à l'arrivée.";
      message.className="error";
      return false;
    }
    message.textContent="";
    return true;
  }

  dateArriveeInput.addEventListener("change", ()=>{
    updateHourOptions(dateArriveeInput, heureArriveeSelect);
    dateDepartInput.min=dateArriveeInput.value;
    validateDatesAndHours();
  });
  heureArriveeSelect.addEventListener("change", validateDatesAndHours);
  dateDepartInput.addEventListener("change", ()=>{
    updateHourOptions(dateDepartInput, heureDepartSelect);
    validateDatesAndHours();
  });
  heureDepartSelect.addEventListener("change", validateDatesAndHours);

  // --- Soumission du formulaire ---
  form.addEventListener("submit", async e=>{
    e.preventDefault();
    if(!validateDatesAndHours()) return;

    message.textContent="Envoi en cours...";

    const formData = new FormData(form);
    const reservation = {
      nom_proprietaire: formData.get("nom_proprietaire"),
      email: formData.get("email"),
      nb_chien: parseInt(formData.get("nb_chien")),
      nom_chien: [],
      date_arrivee: formData.get("date_arrivee"),
      heure_arrivee: formData.get("heure_arrivee"),
      date_depart: formData.get("date_depart"),
      heure_depart: formData.get("heure_depart"),
      remarque: formData.get("remarque")
    };

    let nomsChiensArray = [];
    for(let i = 1; i <= reservation.nb_chien; i++){
      const name = formData.get(`nom_chien_input_${i}`);
      if(name) nomsChiensArray.push(name);
    }
    
    // Transforme le tableau en chaîne
    reservation.nom_chien = nomsChiensArray.join(",");


    try{
      const {data,error} = await supabaseClient
        .from("reservations")
        .insert([reservation])
        .select();
      if(error){
        message.textContent="❌ Erreur : "+error.message;
        message.className="error";
      } else{
        message.textContent="✅ Réservation enregistrée avec succès !";
        message.className="success";
        form.reset();
        nomsChiensContainer.innerHTML = "";
        dateArriveeInput.value = todayStr;
        dateDepartInput.value = todayStr;
        updateHourOptions(dateArriveeInput, heureArriveeSelect);
        updateHourOptions(dateDepartInput, heureDepartSelect);
        updateNomsChiens(); // régénérer le champ après reset
      }
    }catch(err){
      message.textContent="⚡ Exception : "+err.message;
      message.className="error";
    }
  });
</script>
</body>
</html>







